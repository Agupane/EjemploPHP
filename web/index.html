<!DOCTYPE html>
<html lang="en">
<head>
    <title>Gestor de tareas</title>
    <meta charset="UTF-8">
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css">
    <!--
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    -->
    <script src="../js/jquery-3.1.1.js"></script>
    <script src="../js/bootstrap.min.js"></script>

    <script type="text/javascript">
        var itemNuevaTarea,tareaSelected,indexTareaSelected;
        var nombreProyectoSeleccionado = "Proyecto 1";
        var idProyectoSelected = 1;
        var listaTareas = [{
            id:"1",
            nombre:"tarea1",
            minutosTrabajados:"1",
            horasEstimadas:"3",
            idResponsable:"2",
            idProyecto:"1",
            idPrioridad:"1",
            finalizada: false
        },
            {
                id:"2",
                nombre:"tarea2",
                minutosTrabajados:"60",
                horasEstimadas:"1",
                idResponsable:"5",
                idProyecto:"2",
                idPrioridad:"2",
                finalizada: true
            }];


        /** Asigna los listeners a los componentes HTML */
        function cargarComponentes() {
            $("#menuTop").load("menuTop.html");
            $("#tituloNombreProyecto").text("Proyecto: " + nombreProyectoSeleccionado);
            cargarTareas();

            /** Listener que abre la ventana modal de creacion de tarea */
            $("#btnAddTarea").click (function() {
                jQuery.noConflict();
                $("#modalNuevaTarea").modal("show");
            });
            /** Listener para borrar la tarea seleccionada */
            $("#btnBorrarTarea").click (function(){
               borrarTarea(indexTareaSelected);
            });

            /** Recibe evento de click en tarea de la tabla */
            $("#tablaTareas").on("click","tr",function() {
                indexTareaSelected = $(this).index();
                itemTareaSelected(indexTareaSelected);
            });
        }
        /** Carga todas las tareas del array de tareas en la tabla de tareas */
        function cargarTareas(){
            for (var i = 0, len = listaTareas.length; i < len; i++) {
                var tareaI = listaTareas[i];
                agregarTareaATabla(tareaI);
            }
        }
        /** Evento que se ejecuta cuando se selecciona una fila de la tabla */
        function itemTareaSelected(indiceTarea){
            console.log("seleccionaron un item id: "+indiceTarea);
            tareaSelected = listaTareas[indiceTarea];
            var itemTareaSelected;
            nombreResponsable = getNombreResponsable(tareaSelected.idResponsable);
            if(tareaSelected.finalizada){
                finalizada = "Si";
            }
            else
            {
                finalizada = "No";
            }
            itemTareaSelected =
                    "<tr id=\"tablaTareaSelected\">" +
                    "<td>" +
                    tareaSelected.id+
                    "</td>" +
                    "<td>" +
                    nombreResponsable+
                    "</td>" +
                    "<td>" +
                    tareaSelected.minutosTrabajados+
                    "</td>" +
                    "<td>" +
                    tareaSelected.horasEstimadas+
                    "</td>" +
                    "<td>" +
                    finalizada+
                    "</td>"+
                    "</tr>";
            $("#tablaTareaSelected").replaceWith(itemTareaSelected);
            jQuery.noConflict();
            $("#modalTareaSelected").modal("show");
        }
        /** Recibe el id del responsable y retorna su nombre */
        function getNombreResponsable(idResponsable){
            return "Agustin";  //TODO TERMINAR
        }
        /** Recibe una tarea por parametro y la inserta en la tabla de tareas */
        function agregarTareaATabla(nuevaTarea){
            var finalizada,rowFinalizada,nombreResponsable;
            nombreResponsable = getNombreResponsable(nuevaTarea.idResponsable);
            if(nuevaTarea.finalizada){
                finalizada = "Si";
                rowFinalizada = "<tr class=\"success\">";
            }
            else
            {
                finalizada = "No";
                rowFinalizada = "<tr class=\"danger\">";
            }
            itemNuevaTarea =
                    rowFinalizada +
                    "<td>" +
                       nuevaTarea.id+
                    "</td>" +
                    "<td>" +
                            nombreResponsable+
                    "</td>" +
                    "<td>" +
                        nuevaTarea.minutosTrabajados+
                    "</td>" +
                    "<td>" +
                        nuevaTarea.horasEstimadas+
                    "</td>" +
                    "<td>" +
                        finalizada+
                    "</td>" +
                    "</tr>";
            $("#tablaTareas").append(itemNuevaTarea);
        }
        /** Crea una nueva tarea basada en los datos de los */
        function nuevaTarea(){
            $("#modalNuevaTarea").modal("hide");
            var nombreTarea = $("#inputNombreTarea").val();
            var responsableTarea = $("#inputResponsable").val();
            var horasEstimadasTarea = $("#inputHorasEstimadas").val();
            var prioridadTarea = $("#inputPrioridad").val();
            var responsableTarea = $("#inputResponsable").val();
            var idTarea = listaTareas.length+1; // TODO MODIFICAR
            var nuevaTarea= {
                id:idTarea,
                nombre:nombreTarea,
                minutosTrabajados:"0",
                horasEstimadas:horasEstimadasTarea,
                idResponsable:responsableTarea,
                idProyecto:idProyectoSelected,
                idPrioridad:prioridadTarea,
                finalizada:false
            };
            listaTareas.push(nuevaTarea);
            agregarTareaATabla(nuevaTarea);
            $("#inputNombreTarea").val("");
            $("#inputResponsable").val("");
            $("#inputHorasEstimadas").val("");
            $("#inputPrioridad").val("");
        }
        /** Recibe el indice de la tarea a eliminar y la borra TODO TERMINAR */
        function borrarTarea(indiceTarea){
            /** TODO Arreglar el bug  con el listener de la tabla */
            console.log("indice tarea: "+indiceTarea);
            var tablaNueva = $("<tbody id=\"tablaTareas\">"+ "</tbody>");
            var tablaVieja= $("#tablaTareas");
            listaTareas.splice(indiceTarea, 1);
            tablaVieja.replaceWith(tablaNueva);
          //  $("#tablaTareas").addEventListener("click",itemTareaSelected(indiceTarea));
            $("#tablaTareas").on("click","tr",itemTareaSelected(indexTareaSelected));
            $("#modalTareaSelected").modal("hide");
            cargarTareas();
        }

    </script>
</head>
<body onload="cargarComponentes()">
 <div class ="container">
    <div id="menuTop"></div>
    <div id="menuCentral">
        <div class ="row">
            <div class ="col-md-12">
                <h1 id="tituloNombreProyecto"></h1>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <th>Tarea</th>
                            <th>Responsable</th>
                            <th>Minutos trabajados</th>
                            <th>Horas estimadas</th>
                            <th>Tarea finalizada?</th>
                        </thead>
                        <tbody id="tablaTareas">
                        </tbody>
                    </table>
                </div>
                <button class="btn btn-primary btn-lg" data-toggle="modal" id="btnAddTarea" type="button" >
                    Nueva Tarea
                </button>
            </div>
        </div>
    </div>
    <!-- Modal Nueva Tarea -->
    <div class="modal fade" id="modalNuevaTarea" tabindex="-1" role="dialog"
         aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <button type="button" class="close"
                            data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Cancelar</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">
                        Nueva Tarea
                    </h4>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <form class="form-horizontal" role="form">
                        <!-- Nombre -->
                        <div class="form-group">
                            <label  class="col-sm-2 control-label"
                                    for="inputNombreTarea">Nombre
                            </label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control"
                                       id="inputNombreTarea" placeholder="Nombre de la tarea"/>
                            </div>
                        </div>
                        <!-- Responsable -->
                        <div class="form-group">
                            <label  class="col-sm-2 control-label"
                                    for="inputResponsable">Responsable
                            </label>
                            <div class="col-sm-10">
                                <input type="text" class="form-control"
                                       id="inputResponsable" placeholder="Persona responsable"/>
                            </div>
                        </div>
                        <!-- Prioridad -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label"
                                   for="inputPrioridad">Seleccione la prioridad:
                            </label>
                            <div class="col-sm-10">
                            <select class="form-control" id="inputPrioridad">
                                <option>Alta</option>
                                <option>Media</option>
                                <option>Baja</option>
                            </select>
                            </div>
                        </div>
                        <!-- Horas estimadas -->
                        <div class="form-group">
                            <label class="col-sm-2 control-label"
                                   for="inputHorasEstimadas" >Horas estimadas
                            </label>
                            <div class="col-sm-10">
                                <input type="number" class="form-control"
                                       id="inputHorasEstimadas" placeholder="Horas estimadas de realizacion"/>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-default"
                            data-dismiss="modal">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="nuevaTarea()">
                        Crear tarea
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Tarea Selected -->
    <div class="modal fade" id="modalTareaSelected" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Seleccion tarea</h4>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                            <th>Tarea</th>
                            <th>Responsable</th>
                            <th>Minutos trabajados</th>
                            <th>Horas estimadas</th>
                            <th>Tarea finalizada?</th>
                            </thead>
                            <tbody>
                                <tr id="tablaTareaSelected"></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" id="btnEditarTarea">Editar</button>
                        <button type="button" class="btn btn-primary" id="btnBorrarTarea">Eliminar</button>
                        <button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

</body>
<!--
<script  type="text/javascript" src="../js/jquery-3.1.1.js"></script>
-->
</html>